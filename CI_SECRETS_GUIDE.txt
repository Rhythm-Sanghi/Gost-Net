# üîê GitHub Actions CI/CD - Secrets Configuration Guide

This guide explains how to configure GitHub Secrets for automated APK signing in GitHub Actions.

---

## üìã Overview

The GitHub Actions workflow ([`.github/workflows/build.yml`](.github/workflows/build.yml)) can automatically build and sign release APKs when you push to the `main` branch. However, it needs access to your Android keystore and signing credentials.

**Without secrets:** Builds unsigned debug APKs  
**With secrets:** Builds signed release APKs ready for distribution

---

## üîë Required Secrets

You need to configure **4 secrets** in your GitHub repository:

| Secret Name | Description | Example |
|-------------|-------------|---------|
| `KEYSTORE_BASE64` | Your keystore file encoded as Base64 | `MIIElAIBAzCCBE...` |
| `KEYSTORE_PASSWORD` | Password for the keystore file | `MySecurePassword123` |
| `KEY_ALIAS` | Alias name for your signing key | `ghostnet` |
| `KEY_PASSWORD` | Password for the specific key | `MyKeyPassword456` |

---

## üõ†Ô∏è Step-by-Step Setup

### Step 1: Generate Your Keystore (if you don't have one)

**Option A: Using keytool (recommended)**

```bash
keytool -genkey -v \
  -keystore ghostnet.keystore \
  -alias ghostnet \
  -keyalg RSA \
  -keysize 2048 \
  -validity 10000 \
  -storepass YOUR_KEYSTORE_PASSWORD \
  -keypass YOUR_KEY_PASSWORD
```

**Option B: Using Ghost Net's release_manager.py**

```bash
python release_manager.py
# Choose option to generate keystore
```

**‚ö†Ô∏è Important:** Store your keystore file and passwords securely! You'll need them for all future releases.

---

### Step 2: Encode Keystore as Base64

The keystore file needs to be converted to Base64 for storage in GitHub Secrets.

**Linux/macOS:**
```bash
base64 -w 0 ghostnet.keystore > keystore.txt
cat keystore.txt
# Copy the output
```

**Windows (PowerShell):**
```powershell
[Convert]::ToBase64String([IO.File]::ReadAllBytes("ghostnet.keystore")) | Out-File keystore.txt
Get-Content keystore.txt
# Copy the output
```

**Windows (Git Bash):**
```bash
base64 -w 0 ghostnet.keystore > keystore.txt
cat keystore.txt
# Copy the output
```

**Python (cross-platform):**
```python
import base64

with open('ghostnet.keystore', 'rb') as f:
    encoded = base64.b64encode(f.read()).decode('utf-8')
    
with open('keystore.txt', 'w') as f:
    f.write(encoded)
    
print(encoded)
```

---

### Step 3: Add Secrets to GitHub

1. **Go to your GitHub repository**
   - Navigate to: `https://github.com/YOUR_USERNAME/Ghost_Net`

2. **Open Settings**
   - Click **Settings** tab (top right)

3. **Navigate to Secrets**
   - Click **Secrets and variables** ‚Üí **Actions**

4. **Add Repository Secrets**
   - Click **New repository secret**
   - Add each secret one by one:

#### Secret 1: KEYSTORE_BASE64
```
Name: KEYSTORE_BASE64
Value: [Paste the entire Base64 string from keystore.txt]
```

#### Secret 2: KEYSTORE_PASSWORD
```
Name: KEYSTORE_PASSWORD
Value: YOUR_KEYSTORE_PASSWORD
```

#### Secret 3: KEY_ALIAS
```
Name: KEY_ALIAS
Value: ghostnet
```

#### Secret 4: KEY_PASSWORD
```
Name: KEY_PASSWORD
Value: YOUR_KEY_PASSWORD
```

5. **Verify all 4 secrets are added**
   - You should see all 4 secrets listed under "Repository secrets"

---

## ‚úÖ Testing the Workflow

### Trigger a Build

**Option 1: Push to main**
```bash
git add .
git commit -m "Test CI build"
git push origin main
```

**Option 2: Manual trigger**
- Go to **Actions** tab
- Click **Build Android APK**
- Click **Run workflow** ‚Üí Select `main` branch ‚Üí **Run workflow**

### Monitor the Build

1. Go to **Actions** tab
2. Click on the running workflow
3. Watch the build steps in real-time
4. Check for errors in the logs

### Download the APK

Once the build completes:
1. Scroll to bottom of workflow run page
2. Find **Artifacts** section
3. Download `ghostnet-apk-[run_number].zip`
4. Extract and install the signed APK

---

## üîç Troubleshooting

### Problem: "Secrets not found" error

**Symptoms:** Build creates debug APK instead of release APK

**Solution:**
- Verify all 4 secrets are spelled correctly (case-sensitive)
- Check secret names match exactly: `KEYSTORE_BASE64`, `KEYSTORE_PASSWORD`, `KEY_ALIAS`, `KEY_PASSWORD`
- Secrets only work on branches you've configured (default: `main`)

### Problem: "Invalid keystore format" error

**Symptoms:** Build fails with keystore errors

**Solution:**
- Verify Base64 encoding was done correctly (no line breaks)
- Make sure you encoded the `.keystore` file, not a text file
- Try re-encoding with `base64 -w 0` flag (no wrapping)

### Problem: "Incorrect password" error

**Symptoms:** Build fails during signing step

**Solution:**
- Double-check `KEYSTORE_PASSWORD` matches keystore password
- Verify `KEY_PASSWORD` matches key password
- Test locally first: `keytool -list -keystore ghostnet.keystore`

### Problem: Build succeeds but APK won't install

**Symptoms:** "App not installed" or signature verification errors

**Solution:**
- Verify keystore wasn't corrupted during encoding
- Check that `KEY_ALIAS` matches the alias in your keystore
- Use `apksigner verify` to check signature:
  ```bash
  apksigner verify ghostnet.apk
  ```

### Problem: Out of Memory errors

**Symptoms:** Build fails with Java heap space errors

**Solution:**
- Already handled in workflow with `_JAVA_OPTIONS=-Xmx2048m`
- If persists, increase to `-Xmx4096m` in workflow file

---

## üîí Security Best Practices

### ‚úÖ DO:
- **Store keystore file offline** (encrypted backup drive)
- **Use strong passwords** (16+ characters, mixed case, symbols)
- **Rotate keys periodically** (every 2-3 years)
- **Limit repository access** (only trusted collaborators)
- **Enable 2FA on GitHub** (protects secret access)
- **Use different passwords** for keystore and key

### ‚ùå DON'T:
- **Don't commit keystore to Git** (even private repos)
- **Don't share keystore file** via email/cloud
- **Don't use simple passwords** (e.g., "password123")
- **Don't store passwords in code** (use secrets only)
- **Don't forget to backup keystore** (can't recover if lost)

---

## üì¶ Alternative: Local Signing

If you prefer not to use CI secrets, sign locally:

**Using release_manager.py:**
```bash
python release_manager.py
```

**Manual signing:**
```bash
# Build unsigned release
buildozer android release

# Sign with apksigner
apksigner sign \
  --ks ghostnet.keystore \
  --ks-key-alias ghostnet \
  --out bin/ghostnet-signed.apk \
  bin/ghostnet-release-unsigned.apk

# Verify signature
apksigner verify bin/ghostnet-signed.apk
```

---

## üîÑ Workflow Behavior

### Without Secrets (Debug Mode)
```
‚úÖ Checkout code
‚úÖ Install dependencies
‚úÖ Build debug APK (unsigned)
‚úÖ Upload APK artifact
```

### With Secrets (Release Mode)
```
‚úÖ Checkout code
‚úÖ Install dependencies
‚úÖ Decode keystore from Base64
‚úÖ Build release APK
‚úÖ Sign APK with keystore
‚úÖ Verify signature
‚úÖ Upload signed APK artifact
```

---

## üìä Build Artifacts

### Artifact Naming

```
ghostnet-apk-[run_number]
```

**Example:** `ghostnet-apk-42.zip`

### Artifact Contents

- **Debug build:** `ghostnet-1.0.0-arm64-v8a-debug.apk`
- **Release build:** `ghostnet-1.0.0-arm64-v8a-release-signed.apk`

### Artifact Retention

- Artifacts are kept for **30 days** by default
- Download before expiration
- Can be changed in workflow: `retention-days: 90`

---

## üéØ Summary Checklist

Before enabling CI signing:

- [ ] Generated keystore file (`ghostnet.keystore`)
- [ ] Securely stored keystore passwords
- [ ] Encoded keystore to Base64
- [ ] Added `KEYSTORE_BASE64` secret to GitHub
- [ ] Added `KEYSTORE_PASSWORD` secret to GitHub
- [ ] Added `KEY_ALIAS` secret to GitHub
- [ ] Added `KEY_PASSWORD` secret to GitHub
- [ ] Tested workflow with a push to `main`
- [ ] Downloaded and verified signed APK
- [ ] Backed up keystore file offline

---

## üìû Need Help?

**Workflow not working?**
- Check [workflow logs](../../actions) for detailed errors
- Review [GitHub Actions documentation](https://docs.github.com/en/actions)
- Open an [issue](../../issues/new) with error details

**Security questions?**
- See [SECURITY.md](SECURITY.md) (if exists)
- Review [Android signing documentation](https://developer.android.com/studio/publish/app-signing)

---

## üöÄ What's Next?

Once CI secrets are configured:

1. **Automatic builds** on every push to `main`
2. **Signed APKs** ready for distribution
3. **GitHub Releases** (add release creation to workflow)
4. **F-Droid submission** (requires reproducible builds)

---

**Built with üîê by the Ghost Net team**

*Ghost Net - Message freely, locally, securely* üëª
